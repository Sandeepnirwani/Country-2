<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flag Battle Royale</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
        }

        body {
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            min-height: 100dvh;
            font-family: 'Arial', sans-serif;
            overflow: hidden;
        }

        #gameContainer {
            width: min(100vw, 56.25vh);
            height: min(100vh, 177.7778vw);
            width: min(100vw, 56.25dvh);
            height: min(100dvh, 177.7778vw);
            aspect-ratio: 9/16;
            background: #000;
            position: relative;
            overflow: hidden;
        }

        #topBar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 200;
        }

        .recentWinners {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .recentWinners span {
            color: #999;
            font-size: 11px;
            margin-right: 5px;
        }

        .winnerFlagContainer {
            width: 28px;
            height: 20px;
            border: 2px solid #fff;
            border-radius: 2px;
            overflow: hidden;
            background: #fff;
        }

        .topCountries {
            display: flex;
            gap: 10px;
        }

        .topCountry {
            text-align: center;
        }

        .topFlagContainer {
            width: 32px;
            height: 24px;
            border: 2px solid #ffd700;
            border-radius: 2px;
            margin-bottom: 2px;
            overflow: hidden;
            background: #fff;
        }

        .topCountry .rank {
            color: #ffd700;
            font-size: 9px;
            font-weight: bold;
        }

        #circleContainer {
            position: absolute;
            top: 48%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 78%;
            aspect-ratio: 1/1;
            z-index: 10;
        }

        #circle {
            width: 100%;
            height: 100%;
            background: #ffffff;
            border-radius: 50%;
            border: 12px solid #00ff88;
            box-shadow: 0 0 50px rgba(0, 255, 136, 0.7), 
                        0 0 100px rgba(0, 255, 136, 0.4);
            position: relative;
            overflow: hidden;
        }

        .flagContainer {
            position: absolute;
            width: 35px;
            height: 25px;
            border: 2px solid #333;
            border-radius: 3px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.5);
            pointer-events: none;
            overflow: hidden;
            background: #fff;
        }

        .flagContainer.eliminated {
            animation: fallOut 1.5s ease-out forwards;
            z-index: 5;
        }

        @keyframes fallOut {
            0% {
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
            100% {
                opacity: 0.2;
                transform: translateY(700px) scale(0.5) rotate(720deg);
            }
        }

        .flagContainer.winner {
            animation: celebrate 0.5s ease-in-out infinite;
            z-index: 150;
            border: 3px solid #FFD700;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
        }

        @keyframes celebrate {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.5) rotate(10deg); }
        }

        .flagImg {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        #timer {
            position: absolute;
            top: 95px;
            left: 50%;
            transform: translateX(-50%);
            color: #fff;
            font-size: 52px;
            font-weight: bold;
            text-shadow: 0 0 30px rgba(0, 255, 136, 1);
            z-index: 150;
        }

        #counter {
            position: absolute;
            top: 160px;
            left: 50%;
            transform: translateX(-50%);
            color: #ff3366;
            font-size: 26px;
            font-weight: bold;
            text-shadow: 0 0 15px rgba(255, 51, 102, 0.8);
            z-index: 150;
        }

        #result {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 36px;
            font-weight: bold;
            text-align: center;
            opacity: 0;
            z-index: 250;
            text-shadow: 0 0 30px rgba(0, 0, 0, 1);
            background: rgba(0, 0, 0, 0.9);
            padding: 30px 40px;
            border-radius: 20px;
            border: 4px solid #00ff88;
        }

        #result.show {
            animation: showResult 3s ease-in-out;
        }

        @keyframes showResult {
            0%, 100% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            10%, 90% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        #eliminatedArea {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 220px;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.95), transparent);
            z-index: 1;
            pointer-events: none;
        }

        #eliminatedFlags {
            position: absolute;
            bottom: 8px;
            left: 8px;
            right: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            z-index: 2;
            max-height: 200px;
            overflow-y: auto;
        }

        .eliminatedFlagContainer {
            width: 36px;
            height: 26px;
            border: 2px solid #555;
            border-radius: 2px;
            opacity: 0;
            animation: fadeInEliminated 0.6s ease-out forwards;
            overflow: hidden;
            background: #fff;
        }

        @keyframes fadeInEliminated {
            from { opacity: 0; transform: scale(0.3) rotate(180deg); }
            to { opacity: 0.5; transform: scale(1) rotate(0deg); }
        }

        #redLine {
            position: absolute;
            bottom: 220px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, #ff0000, transparent);
            box-shadow: 0 0 10px #ff0000;
            z-index: 3;
        }

        #startOverlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 300;
            cursor: pointer;
        }

        #startButton {
            background: #00ff88;
            color: #000;
            font-size: 28px;
            font-weight: bold;
            padding: 20px 50px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.6);
            transition: transform 0.2s;
        }

        #startButton:hover {
            transform: scale(1.1);
        }

        #startButton:active {
            transform: scale(0.95);
        }

        .startText {
            color: #fff;
            font-size: 18px;
            margin-top: 20px;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="startOverlay">
            <button id="startButton">START GAME</button>
            <div class="startText">Click to enable sound & start</div>
        </div>

        <div id="topBar">
            <div class="recentWinners">
                <span>WINNERS</span>
                <div id="recentWinnersFlags"></div>
            </div>
            <div class="topCountries">
                <div class="topCountry">
                    <div class="topFlagContainer" id="top1Container"></div>
                    <div class="rank">#1</div>
                </div>
                <div class="topCountry">
                    <div class="topFlagContainer" id="top2Container"></div>
                    <div class="rank">#2</div>
                </div>
                <div class="topCountry">
                    <div class="topFlagContainer" id="top3Container"></div>
                    <div class="rank">#3</div>
                </div>
            </div>
        </div>
        
        <div id="timer">13</div>
        <div id="counter">FLAGS: <span id="flagCount">0</span></div>
        
        <div id="circleContainer">
            <div id="circle"></div>
        </div>
        
        <div id="result"></div>
        
        <div id="redLine"></div>
        <div id="eliminatedArea"></div>
        <div id="eliminatedFlags"></div>
    </div>

    <script>
        const countries = [
            { name: 'India', emoji: 'ðŸ‡®ðŸ‡³' },
            { name: 'Australia', emoji: 'ðŸ‡¦ðŸ‡º' },
            { name: 'Bangladesh', emoji: 'ðŸ‡§ðŸ‡©' },
            { name: 'Belgium', emoji: 'ðŸ‡§ðŸ‡ª' },
            { name: 'China', emoji: 'ðŸ‡¨ðŸ‡³' },
            { name: 'Kuwait', emoji: 'ðŸ‡°ðŸ‡¼' },
            { name: 'Sweden', emoji: 'ðŸ‡¸ðŸ‡ª' },
            { name: 'Mexico', emoji: 'ðŸ‡²ðŸ‡½' },
            { name: 'Ukraine', emoji: 'ðŸ‡ºðŸ‡¦' },
            { name: 'Trinidad', emoji: 'ðŸ‡¹ðŸ‡¹' },
            { name: 'Croatia', emoji: 'ðŸ‡­ðŸ‡·' },
            { name: 'Zimbabwe', emoji: 'ðŸ‡¿ðŸ‡¼' },
            { name: 'Jamaica', emoji: 'ðŸ‡¯ðŸ‡²' },
            { name: 'UK', emoji: 'ðŸ‡¬ðŸ‡§' },
            { name: 'Norway', emoji: 'ðŸ‡³ðŸ‡´' },
            { name: 'Thailand', emoji: 'ðŸ‡¹ðŸ‡­' },
            { name: 'Ecuador', emoji: 'ðŸ‡ªðŸ‡¨' },
            { name: 'Indonesia', emoji: 'ðŸ‡®ðŸ‡©' },
            { name: 'Peru', emoji: 'ðŸ‡µðŸ‡ª' },
            { name: 'Philippines', emoji: 'ðŸ‡µðŸ‡­' },
            { name: 'Singapore', emoji: 'ðŸ‡¸ðŸ‡¬' },
            { name: 'Oman', emoji: 'ðŸ‡´ðŸ‡²' },
            { name: 'South Africa', emoji: 'ðŸ‡¿ðŸ‡¦' },
            { name: 'UAE', emoji: 'ðŸ‡¦ðŸ‡ª' },
            { name: 'Qatar', emoji: 'ðŸ‡¶ðŸ‡¦' },
            { name: 'Cuba', emoji: 'ðŸ‡¨ðŸ‡º' },
            { name: 'Pakistan', emoji: 'ðŸ‡µðŸ‡°' },
            { name: 'Romania', emoji: 'ðŸ‡·ðŸ‡´' },
            { name: 'USA', emoji: 'ðŸ‡ºðŸ‡¸' },
            { name: 'Canada', emoji: 'ðŸ‡¨ðŸ‡¦' },
            { name: 'Turkey', emoji: 'ðŸ‡¹ðŸ‡·' },
            { name: 'Argentina', emoji: 'ðŸ‡¦ðŸ‡·' },
            { name: 'Egypt', emoji: 'ðŸ‡ªðŸ‡¬' },
            { name: 'Malaysia', emoji: 'ðŸ‡²ðŸ‡¾' },
            { name: 'Netherlands', emoji: 'ðŸ‡³ðŸ‡±' },
            { name: 'Poland', emoji: 'ðŸ‡µðŸ‡±' },
            { name: 'Russia', emoji: 'ðŸ‡·ðŸ‡º' },
            { name: 'Lithuania', emoji: 'ðŸ‡±ðŸ‡¹' },
            { name: 'Brazil', emoji: 'ðŸ‡§ðŸ‡·' },
            { name: 'France', emoji: 'ðŸ‡«ðŸ‡·' },
            { name: 'Germany', emoji: 'ðŸ‡©ðŸ‡ª' },
            { name: 'Italy', emoji: 'ðŸ‡®ðŸ‡¹' },
            { name: 'Spain', emoji: 'ðŸ‡ªðŸ‡¸' },
            { name: 'Portugal', emoji: 'ðŸ‡µðŸ‡¹' },
            { name: 'Greece', emoji: 'ðŸ‡¬ðŸ‡·' },
            { name: 'Japan', emoji: 'ðŸ‡¯ðŸ‡µ' },
            { name: 'South Korea', emoji: 'ðŸ‡°ðŸ‡·' },
            { name: 'Vietnam', emoji: 'ðŸ‡»ðŸ‡³' },
            { name: 'Iran', emoji: 'ðŸ‡®ðŸ‡·' },
            { name: 'Iraq', emoji: 'ðŸ‡®ðŸ‡¶' },
            { name: 'Saudi Arabia', emoji: 'ðŸ‡¸ðŸ‡¦' },
            { name: 'Israel', emoji: 'ðŸ‡®ðŸ‡±' },
            { name: 'Nigeria', emoji: 'ðŸ‡³ðŸ‡¬' },
            { name: 'Kenya', emoji: 'ðŸ‡°ðŸ‡ª' },
            { name: 'Morocco', emoji: 'ðŸ‡²ðŸ‡¦' },
            { name: 'Algeria', emoji: 'ðŸ‡©ðŸ‡¿' }
        ];

        let audioContext = null;
        let audioEnabled = false;

        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                audioEnabled = true;
            }
        }

        function playBubbleSound() {
            if (!audioEnabled) return;
            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.frequency.value = 250 + Math.random() * 150;
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.12);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.12);
            } catch (e) {}
        }

        function playEliminationSound() {
            if (!audioEnabled) return;
            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(100, audioContext.currentTime + 0.3);
                oscillator.type = 'square';
                gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (e) {}
        }

        function playWinSound() {
            if (!audioEnabled) return;
            try {
                [0, 0.15, 0.3].forEach((delay, i) => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    oscillator.frequency.value = [523.25, 659.25, 783.99][i];
                    oscillator.type = 'sine';
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime + delay);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + delay + 0.4);
                    oscillator.start(audioContext.currentTime + delay);
                    oscillator.stop(audioContext.currentTime + delay + 0.4);
                });
            } catch (e) {}
        }

        let musicInterval = null;
        function playBackgroundMusic() {
            if (!audioEnabled) return;
            if (musicInterval) return;
            
            musicInterval = setInterval(() => {
                try {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    const notes = [261.63, 293.66, 329.63, 349.23, 392.00];
                    oscillator.frequency.value = notes[Math.floor(Math.random() * notes.length)];
                    oscillator.type = 'triangle';
                    gainNode.gain.setValueAtTime(0.03, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.6);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.6);
                } catch (e) {}
            }, 1000);
        }

        function emojiToCountryCode(emoji) {
            const chars = Array.from(emoji || '');
            if (chars.length < 2) return '';
            const first = chars[0].codePointAt(0);
            const second = chars[1].codePointAt(0);
            if (!first || !second) return '';
            const A = 127462; // Regional indicator A
            const Z = 127487; // Regional indicator Z
            if (first < A || first > Z || second < A || second > Z) return '';
            return String.fromCharCode(first - 127397, second - 127397).toLowerCase();
        }

        function createFlagElement(country) {
            const div = document.createElement('div');
            div.style.width = '100%';
            div.style.height = '100%';
            div.style.display = 'flex';
            div.style.alignItems = 'center';
            div.style.justifyContent = 'center';
            div.style.fontSize = '28px';
            div.style.fontFamily = "'Segoe UI Emoji','Apple Color Emoji','Noto Color Emoji',sans-serif";

            const code = emojiToCountryCode(country.emoji);
            if (code) {
                const img = document.createElement('img');
                img.className = 'flagImg';
                img.alt = country.name + ' flag';
                img.src = `https://flagcdn.com/w80/${code}.png`;
                img.onerror = () => {
                    div.innerHTML = '';
                    div.textContent = country.emoji;
                };
                div.appendChild(img);
            } else {
                div.textContent = country.emoji;
            }

            return div;
        }

        const ROUND_DURATION_MS = 13000;
        const RESULT_DISPLAY_MS = 2500;
        let gameCount = 0;
        let recentWinners = [];
        const topCountries = [countries[0], countries[1], countries[2]];
        let roundAnimationId = null;
        let nextRoundTimeoutId = null;

        function updateTopCountries() {
            document.getElementById('top1Container').innerHTML = '';
            document.getElementById('top2Container').innerHTML = '';
            document.getElementById('top3Container').innerHTML = '';
            
            document.getElementById('top1Container').appendChild(createFlagElement(topCountries[0]));
            document.getElementById('top2Container').appendChild(createFlagElement(topCountries[1]));
            document.getElementById('top3Container').appendChild(createFlagElement(topCountries[2]));
        }

        function updateRecentWinners() {
            const container = document.getElementById('recentWinnersFlags');
            container.innerHTML = '';
            recentWinners.slice(-4).forEach(country => {
                const div = document.createElement('div');
                div.className = 'winnerFlagContainer';
                div.appendChild(createFlagElement(country));
                container.appendChild(div);
            });
        }

        class Flag {
            constructor(country, x, y, vx, vy) {
                this.country = country;
                this.x = x;
                this.y = y;
                this.vx = vx;
                this.vy = vy;
                this.element = document.createElement('div');
                this.element.className = 'flagContainer';
                this.element.appendChild(createFlagElement(country));
                this.eliminated = false;
                this.radius = 17.5;
                this.isProtected = false;
            }

            update(centerX, centerY, maxRadius, otherFlags, eliminationAngle, speedFactor) {
                if (this.eliminated) return false;

                const baseSpeed = 2.5 * speedFactor;
                
                otherFlags.forEach(other => {
                    if (other === this || other.eliminated) return;
                    const dx = other.x - this.x;
                    const dy = other.y - this.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    const minDist = this.radius + other.radius;
                    
                    if (dist < minDist && dist > 0) {
                        const overlap = minDist - dist;
                        const nx = dx / dist;
                        const ny = dy / dist;
                        
                        const pushX = nx * overlap * 0.5;
                        const pushY = ny * overlap * 0.5;
                        
                        this.x -= pushX;
                        this.y -= pushY;
                        other.x += pushX;
                        other.y += pushY;
                        
                        const rvx = other.vx - this.vx;
                        const rvy = other.vy - this.vy;
                        const dotProd = rvx * nx + rvy * ny;
                        
                        if (dotProd > 0) {
                            const bounce = 0.8;
                            this.vx += nx * dotProd * bounce;
                            this.vy += ny * dotProd * bounce;
                            other.vx -= nx * dotProd * bounce;
                            other.vy -= ny * dotProd * bounce;
                            
                            if (Math.random() < 0.2) playBubbleSound();
                        }
                    }
                });

                this.x += this.vx;
                this.y += this.vy;

                const dx = this.x - centerX;
                const dy = this.y - centerY;
                const distFromCenter = Math.sqrt(dx * dx + dy * dy);
                
                if (distFromCenter + this.radius > maxRadius) {
                    const angle = Math.atan2(dy, dx);
                    this.x = centerX + Math.cos(angle) * (maxRadius - this.radius);
                    this.y = centerY + Math.sin(angle) * (maxRadius - this.radius);
                    
                    const nx = dx / distFromCenter;
                    const ny = dy / distFromCenter;
                    const dotProd = this.vx * nx + this.vy * ny;
                    this.vx -= 2 * dotProd * nx * 0.8;
                    this.vy -= 2 * dotProd * ny * 0.8;
                }

                const speed = Math.sqrt(this.vx * this.vx + this.vy * this.vy);
                if (speed > 0.1) {
                    const targetSpeed = baseSpeed + Math.random() * 0.3;
                    this.vx = (this.vx / speed) * targetSpeed;
                    this.vy = (this.vy / speed) * targetSpeed;
                }

                if (!this.isProtected) {
                    const angleToFlag = Math.atan2(dy, dx);
                    const normalizedAngle = ((angleToFlag + Math.PI * 2) % (Math.PI * 2));
                    const topAngle = eliminationAngle;
                    let angleDiff = Math.abs(normalizedAngle - topAngle);
                    if (angleDiff > Math.PI) angleDiff = Math.PI * 2 - angleDiff;
                    
                    // Expand elimination zone as speed rises so rounds don't stall.
                    const gapAngle = Math.min(0.95, 0.35 + Math.max(0, speedFactor - 1) * 0.22);
                    const eliminationDist = maxRadius - this.radius - (8 + Math.min(14, Math.max(0, speedFactor - 1) * 8));
                    
                    if (angleDiff < gapAngle && distFromCenter > eliminationDist) {
                        return true;
                    }
                }

                this.element.style.left = (this.x - this.radius) + 'px';
                this.element.style.top = (this.y - this.radius * 0.7) + 'px';

                return false;
            }

            eliminate() {
                this.eliminated = true;
                this.element.classList.add('eliminated');
                playEliminationSound();
            }
        }

        function startRoundLegacy() {
            gameCount++;
            const circle = document.getElementById('circle');
            const timerEl = document.getElementById('timer');
            const counterEl = document.getElementById('flagCount');
            const resultEl = document.getElementById('result');
            const eliminatedContainer = document.getElementById('eliminatedFlags');
            
            circle.innerHTML = '';
            eliminatedContainer.innerHTML = '';
            resultEl.classList.remove('show');
            
            const indiaWins = (gameCount % 10 === 2 || gameCount % 10 === 4 || gameCount % 10 === 7 || gameCount % 10 === 0);
            
            const shuffled = [...countries].sort(() => Math.random() - 0.5);
            let selectedCountries = indiaWins 
                ? [countries.find(c => c.name === 'India'), ...shuffled.filter(c => c.name !== 'India')]
                : shuffled;

            const rect = circle.getBoundingClientRect();
            const centerX = rect.width / 2;
            const centerY = rect.height / 2;
            const radius = rect.width / 2 - 15;

            const flags = [];
            selectedCountries.forEach((country, i) => {
                const angle = (i / selectedCountries.length) * 2 * Math.PI;
                const dist = Math.random() * (radius - 60) + 20;
                const x = centerX + Math.cos(angle) * dist;
                const y = centerY + Math.sin(angle) * dist;
                
                const speed = 2.5;
                const randomAngle = Math.random() * Math.PI * 2;
                const vx = Math.cos(randomAngle) * speed;
                const vy = Math.sin(randomAngle) * speed;
                
                const flag = new Flag(country, x, y, vx, vy);
                
                if (country.name === 'India' && indiaWins) {
                    flag.isProtected = true;
                }
                
                flags.push(flag);
                circle.appendChild(flag.element);
            });

            counterEl.textContent = flags.length;

            let timeLeft = 13;
            let eliminationCooldown = 0;
            timerEl.textContent = timeLeft;
            
            const countdown = setInterval(() => {
                timeLeft--;
                timerEl.textContent = timeLeft;
                if (timeLeft <= 0) clearInterval(countdown);
            }, 1000);

            const animate = () => {
                const activeFlags = flags.filter(f => !f.eliminated);
                
                if (activeFlags.length === 1 || (activeFlags.length === 0 && timeLeft <= 0)) {
                    clearInterval(countdown);
                    
                    let winner;
                    if (activeFlags.length === 1) {
                        winner = activeFlags[0].country;
                        activeFlags[0].element.classList.add('winner');
                    } else {
                        winner = flags[flags.length - 1].country;
                    }
                    
                    if (indiaWins && winner.name !== 'India') {
                        const indiaFlag = flags.find(f => f.country.name === 'India');
                        if (indiaFlag) {
                            winner = indiaFlag.country;
                            indiaFlag.element.classList.add('winner');
                        }
                    }
                    
                    recentWinners.push(winner);
                    updateRecentWinners();
                    
                    playWinSound();
                    resultEl.innerHTML = winner.name === 'India' 
                        ? 'ðŸŽ‰ INDIA WINS! ðŸŽ‰<br><span style="font-size:20px;">à¤­à¤¾à¤°à¤¤ à¤œà¥€à¤¤ à¤—à¤¯à¤¾!</span>' 
                        : `ðŸ† ${winner.name.toUpperCase()} WINS! ðŸ†`;
                    resultEl.style.color = winner.name === 'India' ? '#FF9933' : '#00ff88';
                    resultEl.classList.add('show');
                    
                    setTimeout(() => startRound(), 4000);
                    return;
                }

                eliminationCooldown--;
                
                if (activeFlags.length > 1) {
                    activeFlags.forEach(flag => {
                        const shouldEliminate = flag.update(centerX, centerY, radius, activeFlags);
                        if (shouldEliminate && eliminationCooldown <= 0) {
                            flag.eliminate();
                            eliminationCooldown = 20;
                            
                            setTimeout(() => {
                                const div = document.createElement('div');
                                div.className = 'eliminatedFlagContainer';
                                div.appendChild(createFlagElement(flag.country));
                                eliminatedContainer.appendChild(div);
                            }, 1000);
                        }
                    });
                } else {
                    activeFlags.forEach(flag => {
                        flag.update(centerX, centerY, radius, activeFlags);
                    });
                }

                counterEl.textContent = activeFlags.length;
                requestAnimationFrame(animate);
            };

            animate();
        }

        // Override with stable timed round loop (13s hard stop + smoother in-circle motion).
        function startRound() {
            if (roundAnimationId) {
                cancelAnimationFrame(roundAnimationId);
                roundAnimationId = null;
            }
            if (nextRoundTimeoutId) {
                clearTimeout(nextRoundTimeoutId);
                nextRoundTimeoutId = null;
            }

            gameCount++;
            const circle = document.getElementById('circle');
            const timerEl = document.getElementById('timer');
            const counterEl = document.getElementById('flagCount');
            const resultEl = document.getElementById('result');
            const eliminatedContainer = document.getElementById('eliminatedFlags');

            circle.innerHTML = '';
            eliminatedContainer.innerHTML = '';
            resultEl.classList.remove('show');

            const indiaWins = (gameCount % 10 === 2 || gameCount % 10 === 4 || gameCount % 10 === 7 || gameCount % 10 === 0);

            const shuffled = [...countries].sort(() => Math.random() - 0.5);
            const selectedCountries = indiaWins
                ? [countries.find(c => c.name === 'India'), ...shuffled.filter(c => c.name !== 'India')]
                : shuffled;

            const rect = circle.getBoundingClientRect();
            const centerX = rect.width / 2;
            const centerY = rect.height / 2;
            const radius = rect.width / 2 - 15;

            const flags = [];
            selectedCountries.forEach((country, i) => {
                const angle = (i / selectedCountries.length) * 2 * Math.PI;
                const dist = Math.random() * (radius - 60) + 20;
                const x = centerX + Math.cos(angle) * dist;
                const y = centerY + Math.sin(angle) * dist;

                const speed = 2.5;
                const randomAngle = Math.random() * Math.PI * 2;
                const vx = Math.cos(randomAngle) * speed;
                const vy = Math.sin(randomAngle) * speed;

                const flag = new Flag(country, x, y, vx, vy);
                if (country.name === 'India' && indiaWins) flag.isProtected = true;

                flags.push(flag);
                circle.appendChild(flag.element);
            });

            counterEl.textContent = flags.length;
            timerEl.textContent = Math.ceil(ROUND_DURATION_MS / 1000);

            let eliminationCooldown = 0;
            let roundEnded = false;
            const roundStartTime = performance.now();
            let lastForcedEliminationAt = 0;

            const finishRound = (activeFlags) => {
                if (roundEnded) return;
                roundEnded = true;

                if (roundAnimationId) {
                    cancelAnimationFrame(roundAnimationId);
                    roundAnimationId = null;
                }

                let winner;
                if (activeFlags.length === 1) {
                    winner = activeFlags[0].country;
                    activeFlags[0].element.classList.add('winner');
                } else {
                    const pool = activeFlags.length ? activeFlags : flags.filter(f => !f.eliminated);
                    const pickPool = pool.length ? pool : flags;
                    winner = pickPool[Math.floor(Math.random() * pickPool.length)].country;
                }

                if (indiaWins && winner.name !== 'India') {
                    const indiaFlag = flags.find(f => f.country.name === 'India');
                    if (indiaFlag) {
                        winner = indiaFlag.country;
                        indiaFlag.element.classList.add('winner');
                    }
                }

                recentWinners.push(winner);
                if (recentWinners.length > 20) recentWinners = recentWinners.slice(-20);
                updateRecentWinners();

                playWinSound();
                resultEl.innerHTML = winner.name === 'India'
                    ? 'INDIA WINS!<br><span style="font-size:20px;">Bharat Jeet Gaya!</span>'
                    : `${winner.name.toUpperCase()} WINS!`;
                resultEl.style.color = winner.name === 'India' ? '#FF9933' : '#00ff88';
                resultEl.classList.add('show');

                nextRoundTimeoutId = setTimeout(() => startRound(), RESULT_DISPLAY_MS);
            };

            const animate = () => {
                if (roundEnded) return;

                const activeFlags = flags.filter(f => !f.eliminated);
                const elapsed = performance.now() - roundStartTime;
                const roundProgress = Math.min(1, elapsed / ROUND_DURATION_MS);
                const inSuddenDeath = elapsed >= ROUND_DURATION_MS;
                const speedFactor = 1 + roundProgress * 1.8 + (inSuddenDeath ? 0.8 : 0);
                const eliminationAngle = (Math.PI * 1.5 + elapsed * (inSuddenDeath ? 0.003 : 0.0018)) % (Math.PI * 2);
                timerEl.textContent = Math.max(0, Math.ceil((ROUND_DURATION_MS - elapsed) / 1000));

                // Winner is valid only when exactly one flag remains.
                if (activeFlags.length <= 1) {
                    finishRound(activeFlags);
                    return;
                }

                eliminationCooldown = Math.max(0, eliminationCooldown - 1);

                activeFlags.forEach(flag => {
                    const shouldEliminate = flag.update(
                        centerX,
                        centerY,
                        radius,
                        activeFlags,
                        eliminationAngle,
                        speedFactor
                    );

                    if (shouldEliminate && eliminationCooldown === 0) {
                        flag.eliminate();
                        eliminationCooldown = inSuddenDeath ? 1 : 4;

                        setTimeout(() => {
                            const div = document.createElement('div');
                            div.className = 'eliminatedFlagContainer';
                            div.appendChild(createFlagElement(flag.country));
                            eliminatedContainer.appendChild(div);
                        }, 350);
                    }
                });

                // After 13s, force rapid eliminations to avoid stalled rounds.
                if (inSuddenDeath && activeFlags.length > 1 && (elapsed - lastForcedEliminationAt) > 180) {
                    const nonIndia = activeFlags.filter(f => !(indiaWins && f.country.name === 'India'));
                    const pool = nonIndia.length > 0 ? nonIndia : activeFlags;
                    const victim = pool[Math.floor(Math.random() * pool.length)];
                    victim.eliminate();
                    lastForcedEliminationAt = elapsed;

                    setTimeout(() => {
                        const div = document.createElement('div');
                        div.className = 'eliminatedFlagContainer';
                        div.appendChild(createFlagElement(victim.country));
                        eliminatedContainer.appendChild(div);
                    }, 120);
                }

                counterEl.textContent = flags.filter(f => !f.eliminated).length;
                roundAnimationId = requestAnimationFrame(animate);
            };

            roundAnimationId = requestAnimationFrame(animate);
        }

        // Autoplay round loop; first user touch enables sound.
        window.addEventListener('load', () => {
            updateTopCountries();
            document.getElementById('startOverlay').style.display = 'none';
            setTimeout(() => startRound(), 250);
        });

        document.getElementById('startButton').addEventListener('click', () => {
            if (!audioEnabled) {
                initAudio();
                playBackgroundMusic();
            }
        });

        document.addEventListener('pointerdown', () => {
            if (!audioEnabled) {
                initAudio();
                playBackgroundMusic();
            }
        }, { once: true });
    </script>
</body>
</html>
