<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>COUNTRY SPEED BATTLE MINI</title>
    <style>
        :root { --neon:#00f2ff; --gold:#ffcc00; --red:#ff3131; --green:#00ff88; }
        body {
            margin:0; background:#000; overflow:hidden;
            display:flex; justify-content:center; align-items:center;
            font-family:'Arial Black', sans-serif; height: 100vh;
        }
        #stream {
            width:100vw; height:177.77vw;
            max-width:56.25vh; max-height:100vh;
            position:relative; background: radial-gradient(circle, #121225 0%, #000 100%);
        }
        canvas { width:100%; height:100%; display:block; }
        
        .live {
            position:absolute; top:20px; left:20px;
            background:var(--red); padding:4px 10px; font-size: 14px;
            font-weight:900; color:white; border-radius: 4px; z-index: 10;
        }

        /* --- COMPACT RIGHT DASHBOARD --- */
        #dashboard { 
            position:absolute; top:20px; right:20px; 
            background:rgba(0,0,0,0.8); border: 1.5px solid var(--neon);
            color:white; border-radius:8px; z-index:15; width: 70px;
            display: flex; flex-direction: column; align-items: center;
        }
        
        #rem-box {
            width: 100%; background: var(--neon); color: #000;
            text-align: center; padding: 5px 0; border-radius: 6px 6px 0 0;
        }
        #remaining { font-size: 24px; font-weight: 900; }

        #history-box { padding: 5px 0; display: flex; flex-direction: column; gap: 4px; }
        .win-entry { display: flex; justify-content: center; }
        .win-entry img { width: 35px; height: 24px; border-radius: 2px; border: 1px solid #333; }

        #commentary { 
            position:absolute; left:50%; transform:translateX(-50%); 
            top: 40%; width: 80%; text-align: center;
            color: #fff; font-size:32px; font-weight: 900;
            z-index:20; opacity:0; transition: 0.3s;
            text-shadow: 0 0 15px #000; pointer-events: none;
        }

        #ticker { 
            position:absolute; bottom:0; width:100%; height:50px; 
            background:rgba(0,0,0,0.9); display:flex; align-items:center; overflow:hidden; z-index:14;
        }
        #tickerInner { display:flex; gap:20px; white-space:nowrap; animation: scrollTicker 60s linear infinite; }
        @keyframes scrollTicker { 0% { transform: translateX(0); } 100% { transform: translateX(-66.66%); } }
        .tick { display:flex; align-items:center; gap:8px; color:white; font-size: 16px; }
        .tick img { width:32px; height:22px; border-radius:3px; }

        #startOverlay {
            position: absolute; inset: 0; background: #000;
            z-index: 100; display: flex; justify-content: center; align-items: center;
        }
        #startBtn {
            padding: 20px 40px; font-size: 22px; background: var(--green);
            color: black; border: none; border-radius: 40px; font-weight: 900; cursor: pointer;
        }

        #winner {
            position:absolute; inset:0; display:none; 
            align-items:center; justify-content:center; flex-direction:column;
            background:rgba(0,0,0,0.95); z-index:30;
        }
        #winner img { width:200px; height:200px; border-radius:50%; border:8px solid var(--gold); }
        #winner h1 { color:var(--gold); font-size: 3.5rem; margin-top:15px; text-align:center; }
    </style>
</head>
<body>

<div id="startOverlay"><button id="startBtn">START</button></div>

<div id="stream">
    <div class="live">LIVE</div>
    
    <div id="dashboard">
        <div id="rem-box"><div id="remaining">100</div></div>
        <div id="history-box" id="histEntries">
            </div>
    </div>

    <div id="commentary"></div>
    <canvas id="c" width="1080" height="1920"></canvas>
    <div id="ticker"><div id="tickerInner"></div></div>
    
    <div id="winner">
        <img id="winnerImg" src="">
        <h1 id="winnerName"></h1>
    </div>
</div>

<script>
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");
const CENTER = { x: 540, y: 960 }, RADIUS = 480, BALL_R = 32, TOTAL = 100;
let GAP_ANGLE = 0.8;

let balls = [], particles = [], running = false, phase = "IDLE"; 
let slowMo = 1, announced3 = false, arenaRotation = -Math.PI/2, audioCtx;
let roundStart = 0, desiredDuration = 40000, arenaShrink = 0;
let winnerHistory = [];

const countries = [
    {c:'us', n:'USA'},{c:'in', n:'INDIA'},{c:'br', n:'BRAZIL'},{c:'gb', n:'UK'},{c:'fr', n:'FRANCE'},
    {c:'de', n:'GERMANY'},{c:'jp', n:'JAPAN'},{c:'cn', n:'CHINA'},{c:'ru', n:'RUSSIA'},{c:'it', n:'ITALY'},
    {c:'es', n:'SPAIN'},{c:'mx', n:'MEXICO'},{c:'ca', n:'CANADA'},{c:'au', n:'AUSTRALIA'},{c:'kr', n:'KOREA'},
    {c:'id', n:'INDONESIA'},{c:'ng', n:'NIGERIA'},{c:'eg', n:'EGYPT'},{c:'za', n:'S. AFRICA'},{c:'ar', n:'ARGENTINA'}
];
while(countries.length < 100) countries.push(countries[Math.floor(Math.random()*countries.length)]);

const flags = countries.slice(0, 100).map(x => {
    const img = new Image(); img.crossOrigin = "anonymous";
    img.src = `https://flagcdn.com/w160/${x.c.toLowerCase()}.png`;
    return { name: x.n, img };
});

const tickerInner = document.getElementById('tickerInner');
flags.slice(0, 30).forEach(f => {
    tickerInner.innerHTML += `<div class="tick"><img src="${f.img.src}"> <span>${f.name}</span></div>`;
});

function say(t) {
    const comEl = document.getElementById('commentary');
    comEl.textContent = t; comEl.style.opacity = 1;
    setTimeout(() => { if(comEl.textContent === t) comEl.style.opacity = 0; }, 2000);
}

function updateHistory(winner) {
    winnerHistory.unshift(winner);
    if(winnerHistory.length > 4) winnerHistory.pop();
    const container = document.getElementById('history-box');
    container.innerHTML = winnerHistory.map(w => `
        <div class="win-entry"><img src="${w.img.src}"></div>
    `).join('');
}

class Ball {
    constructor(item, index) {
        this.item = item; this.index = index; this.reset();
    }
    reset() {
        this.x = CENTER.x + (Math.random() - 0.5) * 20; 
        this.y = -300 - (this.index * 120); 
        this.vx = 0; this.vy = 18; // Very smooth, steady entry
        this.out = false; this.isInArena = false;
    }
    update() {
        this.x += this.vx * slowMo;
        this.y += this.vy * slowMo;
        const dx = this.x - CENTER.x, dy = this.y - CENTER.y, d = Math.hypot(dx, dy);
        const currentR = RADIUS - arenaShrink;

        if (!this.isInArena && d < currentR - BALL_R) {
            this.isInArena = true;
            this.vx = (Math.random() - 0.5) * 25; this.vy = (Math.random() - 0.5) * 25;
        }

        if (this.isInArena) {
            if (d > currentR - BALL_R) {
                let ang = Math.atan2(dy, dx) - arenaRotation;
                while(ang < -Math.PI) ang += Math.PI*2;
                while(ang > Math.PI) ang -= Math.PI*2;
                if (phase === "BATTLE" && ang > -GAP_ANGLE && ang < GAP_ANGLE) {
                    this.out = true;
                } else {
                    const nx = dx/d, ny = dy/d, dot = (this.vx*nx + this.vy*ny);
                    this.vx -= 2*dot*nx; this.vy -= 2*dot*ny;
                    this.x = CENTER.x + nx*(currentR-BALL_R-2);
                    this.y = CENTER.y + ny*(currentR-BALL_R-2);
                }
            }
        }
    }
    draw() {
        ctx.save(); ctx.beginPath(); ctx.arc(this.x, this.y, BALL_R, 0, Math.PI*2); ctx.clip();
        if(this.item.img.complete) ctx.drawImage(this.item.img, this.x-BALL_R, this.y-BALL_R, BALL_R*2, BALL_R*2);
        ctx.restore();
    }
}

function start() {
    balls = []; announced3 = false; running = true;
    arenaShrink = 0; arenaRotation = -Math.PI/2;
    GAP_ANGLE = 0.8; phase = "ENTRY"; 
    for(let i=0; i<TOTAL; i++) balls.push(new Ball(flags[i], i));
}

function loop() {
    ctx.fillStyle = '#000'; ctx.fillRect(0, 0, 1080, 1920);
    if (running) {
        if (phase === "ENTRY") {
            balls.forEach(b => b.update());
            if (balls.every(b => b.isInArena)) {
                phase = "BATTLE"; GAP_ANGLE = 0.5;
                roundStart = Date.now();
                say("BATTLE START!");
            }
        } else if (phase === "BATTLE") {
            const elapsed = Date.now() - roundStart;
            const progress = Math.min(1, elapsed / desiredDuration);
            let dynamicSpeed = 1.3 + progress * 1.5; 
            slowMo = (announced3 ? 0.7 : 1) * dynamicSpeed;
            arenaRotation += 0.025 * dynamicSpeed;
            if (balls.length === 2) arenaShrink = Math.min(arenaShrink + 1.2, RADIUS - 120);
            balls.forEach(b => b.update());
            balls = balls.filter(b => !b.out);
            if (balls.length === 3 && !announced3) { announced3 = true; say("FINAL 3!"); }
            if (balls.length === 1) {
                running = false; phase = "IDLE";
                const w = balls[0].item;
                updateHistory(w);
                document.getElementById("winnerImg").src = w.img.src;
                document.getElementById("winnerName").textContent = w.name;
                document.getElementById("winner").style.display = "flex";
                setTimeout(() => { document.getElementById("winner").style.display = "none"; start(); }, 5000);
            }
        }
    }
    
    ctx.save(); 
    ctx.translate(CENTER.x, CENTER.y); ctx.rotate(arenaRotation);
    ctx.strokeStyle = phase === "ENTRY" ? "#00ff88" : "#00f2ff"; 
    ctx.lineWidth = 30; ctx.beginPath(); 
    const r = RADIUS - arenaShrink;
    ctx.arc(0, 0, r, GAP_ANGLE, -GAP_ANGLE);
    ctx.stroke(); 
    ctx.restore();
    
    balls.forEach(b => b.draw());
    document.getElementById('remaining').textContent = balls.length;
    requestAnimationFrame(loop);
}

document.getElementById("startBtn").onclick = () => {
    document.getElementById("startOverlay").style.display = "none";
    start();
};
requestAnimationFrame(loop);
</script>
</body>
</html>